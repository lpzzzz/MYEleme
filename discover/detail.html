<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <script src="../js/mui.min.js"></script>
    <link href="../css/mui.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../css/iconfont.css" />
    <link rel="stylesheet" href="../css/style.css" />
	<style>
		#font-s {
			font-size: 12px;
		}
	
		#order-sd {
			font-size: 8px;
			float: right;
		}
	
		#oreder-count {
			font-size: 10px;
		}
	</style>
</head>
<body>
	<header class="mui-bar mui-bar-nav">
	    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	    <h1 class="mui-title">商品详情</h1>
	</header>
	<div class="mui-content">
	    <div class="detail-div">
	    	<div class="detail-div-t">
	    		<img src="../img/detail/detail_show(1).webp" alt="" />
	    		<div class="spxq-div">
					<div class="wm-list-div-r-t-l info">
						<span class="mui-icon mui-icon-star-filled star-ys"></span>
						<span class="mui-icon mui-icon-star-filled star-ys"></span>
						<span class="mui-icon mui-icon-star-filled star-ys"></span>
						<span class="mui-icon mui-icon-star-filled star-ys"></span>
						<span class="mui-icon mui-icon-star-filled star-ys"></span>
					</div>
					<div>
						<span class="small-txt">&nbsp;<span class="info">100000</span>人评价</span>
						<span class="small-txt">月售<span class="info">3200</span>单</span>
						<div class="wm-list-div-r-tt">
							<div class="shop-list-div-jg">
								<h5><span>¥</span><span class="big-txt info">22.4</span><span class="mui-icon mui-icon-plusempty mui-pull-right plus-icon info"></span></h5>
							</div>
						</div>
						</div>
					</div>
				</div>
				
	    	</div>
	    	<div class="pl-list">
				<h5 class="mui-content-padded">客户评价</h5>
				
				<div class="mui-content">
					<ul id="OA_task_1" class="mui-table-view">
						<li class="mui-table-view-cell">
							<div class="mui-slider-right mui-disabled">
								<a class="mui-btn mui-btn-red">删除</a>
							</div>
							<div class="mui-slider-handle">
								<a href="javascript:;" title="叫花鸡">
									<!-- 设置一个 title方便后面获取 商品名称-->
									<img class="mui-media-object mui-pull-left" src="../img/detail/touxiang%20(1).gif">
									<div class="mui-media-body">
										<span id="font-s">
											不识大橘 <span id="order-sd">已评价！</span>
										</span>
										<p class="mui-ellipsis" id="oreder-count">真香</p>
										<p id="oreder-count">2019-06-18 11:23</p>
									</div>
								</a>
							</div>
						</li>
						<li class="mui-table-view-cell">
							<div class="mui-slider-right mui-disabled">
								<a class="mui-btn mui-btn-red">删除</a>
							</div>
							<div class="mui-slider-handle">
								<a href="javascript:;" title="大橘为重">
									<!-- 设置一个 title方便后面获取 商品名称-->
									<img class="mui-media-object mui-pull-left" src="../img/detail/touxiang%20(2).gif">
									<div class="mui-media-body">
										<span id="font-s">
											大橘为重  <span id="order-sd">已评价！</span>
										</span>
										<p class="mui-ellipsis" id="oreder-count">还行</p>
										<p id="oreder-count">2019-06-17 11:23</p>
									</div>
								</a>
							</div>
						</li>
						<li class="mui-table-view-cell">
							<div class="mui-slider-right mui-disabled">
								<a class="mui-btn mui-btn-red">删除</a>
							</div>
							<div class="mui-slider-handle">
								<a href="javascript:;" title="健康诊所">
									<!-- 设置一个 title方便后面获取 商品名称-->
									<img class="mui-media-object mui-pull-left" src="../img/detail/touxiang%20(2).jpg">
									<div class="mui-media-body">
										<span id="font-s">
											虎头鹦  <span id="order-sd">已评价！</span>
										</span>
										<p class="mui-ellipsis" id="oreder-count">好吃</p>
										<p id="oreder-count">2019-06-16 11:23</p>
									</div>
								</a>
							</div>
						</li>
						
						<li class="mui-table-view-cell">
							<div class="mui-slider-right mui-disabled">
								<a class="mui-btn mui-btn-red">删除</a>
							</div>
							<div class="mui-slider-handle">
								<a href="javascript:;" title="叫花鸡">
									<!-- 设置一个 title方便后面获取 商品名称-->
									<img class="mui-media-object mui-pull-left" src="../img/detail/touxiang%20(3).gif">
									<div class="mui-media-body">
										<span id="font-s">
											老司机 <span id="order-sd">已评价！</span>
										</span>
										<p class="mui-ellipsis" id="oreder-count">太美味了</p>
										<p id="oreder-count">2019-06-18 11:23</p>
									</div>
								</a>
							</div>
						</li>
						<li class="mui-table-view-cell">
							<div class="mui-slider-right mui-disabled">
								<a class="mui-btn mui-btn-red">删除</a>
							</div>
							<div class="mui-slider-handle">
								<a href="javascript:;" title="大橘为重">
									<!-- 设置一个 title方便后面获取 商品名称-->
									<img class="mui-media-object mui-pull-left" src="../img/detail/touxiang%20(3).jpg">
									<div class="mui-media-body">
										<span id="font-s">
											小黑子  <span id="order-sd">已评价！</span>
										</span>
										<p class="mui-ellipsis" id="oreder-count">太好吃了</p>
										<p id="oreder-count">2019-06-17 11:23</p>
									</div>
								</a>
							</div>
						</li>
						<li class="mui-table-view-cell">
							<div class="mui-slider-right mui-disabled">
								<a class="mui-btn mui-btn-red">删除</a>
							</div>
							<div class="mui-slider-handle">
								<a href="javascript:;" title="健康诊所">
									<!-- 设置一个 title方便后面获取 商品名称-->
									<img class="mui-media-object mui-pull-left" src="../img/detail/touxiang%20(5).jpg">
									<div class="mui-media-body">
										<span id="font-s">
											我来自马达加斯加  <span id="order-sd">已评价！</span>
										</span>
										<p class="mui-ellipsis" id="oreder-count">鹅吃了都说好，我不是刷单的</p>
										<p id="oreder-count">2019-06-16 11:23</p>
									</div>
								</a>
							</div>
						</li>
					</ul>
				</div>
			</div>
	    </div>
	    
	    <div class="shop-car">
			<div class="shop-car-l">
				<span class="mui-icon mui-icon-paperplane fj-icon"></span>
				<span>¥<span class="info">0</span></span>
			</div>
			<div class="shop-car-r">
				<span>¥<span class="info">38</span>起送</span>
				<button id="btn">去付款</button>
			</div>
		</div>
	</div>
	<script src="../js/castapp.js"></script>
	<script>
		
		ca.init('','H5BE68F9B');
		
		var item_id = localStorage.getItem('item_id');
		var info = ca.className('info');
		var comment_list = ca.id('comment_list');
		
		
		var request_url = localStorage.getItem('request_url');
		
		//我们有的时候请求数据库写在函数内，又得时候写在函数外
		
		get_item();
		function get_item(){
		
			ca.get({
				url:request_url + 'Item/get_one',
				data:{
					id_data:item_id
				},succFn:function(data){
					
					var json = JSON.parse(data);
					//获得平均分
					var pj_num = json.pj_num;
					
					var span = info['0'].getElementsByTagName('span');
					
					for(var a=0;a<span.length;a++){
						if(a < pj_num){
							span[a].className = "mui-icon mui-icon-star-filled star-ys star-sctive";
						}else{
							span[a].className = "mui-icon mui-icon-star-filled star-ys";
						}
					}
					
					
					info['1'].innerHTML = json.comment_number;
					
					info['2'].innerHTML = json.buy_number;
					info['3'].innerHTML = info['6'].innerHTML =  json.price;
					
					
					//获得所有评价
					var comment_arr = json.comment_arr;
					for(var s in comment_arr){
						
						var user_data = comment_arr[s].user_data;
						var img_url = localStorage.getItem('img_url');
						if(user_data.head_img){
							var h = img_url + user_data.head_img;
						}else{
							var h = 'images/head.jpg';
						}
						
						//循环分
						var num1 = comment_arr[s].num1;
						var tmpl1 = '';
						for(var f=0;f<5;f++){
							if(num1 > f){
								tmpl1 += '<span class="mui-icon mui-icon-star-filled star-ys star-sctive"></span>';
							}else{
								tmpl1 += '<span class="mui-icon mui-icon-star-filled star-ys"></span>';
							}
						}
						
						
						
						var tmpl = '<div class="pl-list-div public-clear-both">'
									+'	<div class="pl-list-div-l">'
									+'		<img src="'+h+'" alt="" />'
									+'	</div>'
									+'	<div class="pl-list-div-r">'
									+'		<p><span>'+user_data.nickname+'</span><span class="mui-pull-right">'+comment_arr[s].time+'</span></p>'
									+'		<div class="wm-list-div-r-t">'
									+'			<div class="wm-list-div-r-t-l">'
									+tmpl1
//									+'				<span class="mui-icon mui-icon-star-filled star-ys star-sctive"></span>'
//									+'				<span class="mui-icon mui-icon-star-filled star-ys star-sctive"></span>'
//									+'				<span class="mui-icon mui-icon-star-filled star-ys star-sctive"></span>'
//									+'				<span class="mui-icon mui-icon-star-filled star-ys star-sctive"></span>'
//									+'				<span class="mui-icon mui-icon-star-filled star-ys"></span>'
									+'			</div>'
									+'			<span class="small-txt" style="margin-left:10px;color:#999;"></span>'
									+'		</div>'
									+'		<p class="pj-c">'+comment_arr[s].content+'</p>'
									+'	</div>'
									+'</div>'
						comment_list.innerHTML += tmpl;
					}
					
					
				}
			})
		
		
		}
		
		//加入购物车
		info['4'].addEventListener('tap',function(){
			info['5'].innerHTML = parseFloat(info['5'].innerHTML) + parseFloat(info['6'].innerHTML);
		})
		
		var btn = ca.id('btn');
		
		
		
		btn.addEventListener('tap',function(){
			
			//先判断是否登录
			var login_phone = localStorage.getItem('login_phone');
			if(!login_phone){
				ca.prompt('请登录');
				ca.newInterface({
					url:'../login/login.html',
					id:'login'
				});
				return;
			}
			
			
			var money = info['5'].innerHTML;
			if(parseFloat(money) < 0.000001){
				ca.prompt('请选购后付款');
				return;
			}
			
			
			
			//订单流程 -> 产生一个订单(未付款)->跳转到支付界面->支付成功->吧订单状态改成已付款
			//						   ->扣除余额
			//产生一个订单
			ca.get({
				url:request_url+'Item/create_order',
				data:{
					phone_data:login_phone,
					item_data:item_id,
					money_data:money
				},succFn:function(data){
//					alert(data);
					if(data > 0){
						//判断是否有余额够支付
						var user_json = JSON.parse(localStorage.getItem('user_data'));
						if(parseFloat(user_json.money) >= parseFloat(money)){
							
							//询问一下，是否使用账户支付
							var btnArray = ['是','否'];
						    mui.confirm('是否使用余额支付？','支付提醒',btnArray,function(e){
							    if(e.index==0){
							        
							        ca.get({
							        	url:request_url + 'Item/money_pay',
							        	data:{
							        		phone_data:login_phone,
							        		money_data:money
							        	},succFn:function(aa){
							        		
							        		if(aa == 1){
							        			
							        			var arr = ['home'];
							        			ca.sendNotice(arr,'update',{});
							        			
							        			mod_state(data);
							        		}else{
							        			ca.prompt('下单失败');
							        		}
							        		
							        		
							        	}
							        })
							        
							        
							        
							        //自己的逻辑                    
							    }else{
							        pay(money,data);
							    }
							});
							
						}else{
							
							if(user_json.money == 0 || !user_json.money){
								pay(data);
							}else{
								var new_money = money-user_json.money;
							
								ca.get({
						        	url:request_url + 'Item/money_pay',
						        	data:{
						        		phone_data:login_phone,
						        		money_data:user_json.money
						        	},succFn:function(aa){
						        		
						        		if(aa == 1){
						        			var arr = ['home'];
							        		ca.sendNotice(arr,'update',{});
						        			pay(new_money,data);
						        		}else{
						        			ca.prompt('下单失败');
						        		}
						        		
						        		
						        	}
						        })	
							}		
						};
						
						
						
						
						
						
						
						
					}else{
						ca.prompt('下单失败,请重试');
					}
				}
			})
			
			

			
			
			
		});
		
		
		function pay(money,id){
			var code = ca.getIdCode(10);
			castapp.pay({
			    name:'ele订单:'+code,
			    appid:'2016010720042564848',
			    appkey:'ed4qj6la1xv5wskh0b8m',
			    type:'alipay',
			    money:0.1, //money
			    succFn:function(){
			        
			       mod_state(id);


			    }
			});
		}
		
		function mod_state(data){
			 //吧订单状态改成已付款
			ca.get({
				url:request_url+'Item/mod_state',
				data:{
					id_data:data
				},succFn:function(d){
					if(d == 1){
						ca.prompt('下单成功');
						
						
						var arr = ['order'];
						ca.sendNotice(arr,'update_order',{});
						
					}else{
						ca.prompt('下单失败,请重试');
					}
				}
			})
		}
		
		
		mui.init();
		(function($) {
			//$.swipeoutOpen(el,direction)//打开指定列的滑动菜单，el:指定列的dom对象，direction：取值left|right，指定打开的是左侧或右侧滑动菜单
			//$.swipeoutClose(el);//关闭指定列的滑动菜单，el:指定列的dom对象
			//				setTimeout(function() {
			//					$.swipeoutOpen(document.getElementById("OA_task_1").querySelector('li:last-child'), 'left');
			//					setTimeout(function() {
			//						$.swipeoutClose(document.getElementById("OA_task_1").querySelector('li:last-child'));
			//					}, 1000);
			//				}, 1000);
			//第一个demo，拖拽后显示操作图标，点击操作图标删除元素；
			$('#OA_task_1').on('tap', '.mui-btn', function(event) {
				var elem = this;
				var li = elem.parentNode.parentNode;
				mui.confirm('确认删除该条记录？', 'Hello MUI', btnArray, function(e) {
					if (e.index == 0) {
						li.parentNode.removeChild(li);
					} else {
						setTimeout(function() {
							$.swipeoutClose(li);
						}, 0);
					}
				});
			});
			var btnArray = ['确认', '取消'];
			//第二个demo，向左拖拽后显示操作图标，释放后自动触发的业务逻辑
			$('#OA_task_2').on('slideleft', '.mui-table-view-cell', function(event) {
				var elem = this;
				mui.confirm('确认删除该条记录？', 'Hello MUI', btnArray, function(e) {
					if (e.index == 0) {
						elem.parentNode.removeChild(elem);
					} else {
						setTimeout(function() {
							$.swipeoutClose(elem);
						}, 0);
					}
				});
			});
			//第二个demo，向右拖拽后显示操作图标，释放后自动触发的业务逻辑
			$('#OA_task_2').on('slideright', '.mui-table-view-cell', function(event) {
				var elem = this;
				mui.confirm('确认删除该条记录？', 'Hello MUI', btnArray, function(e) {
					if (e.index == 0) {
						elem.parentNode.removeChild(elem);
					} else {
						setTimeout(function() {
							$.swipeoutClose(elem);
						}, 0);
					}
				});
			});
		})(mui);
		
		
	</script>
</body>
</html>